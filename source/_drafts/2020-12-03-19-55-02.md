---
created: 2020-12-03T19:55:02+01:00
title: foreman provisioning tests mit gitlab-ci und serverspec
modified: 2020-12-03T20:10:24+01:00
---

Eines meiner Hauptbeschäftigungen ist die Pflege unseres Foreman und Pflege der diversen Betriebssysteme, die wir tagtäglich an unsere Kunden ausliefern. Nachdem immer wieder neue Releases kommen, Anforderungen verändert werden oder einfach mal ein Update des Betriebssystems den Provisionierungsprozess verändert, habe ich mir mal die Zeit genommen einen automatischen Test des Provisionings zu bauen. Hier hat sich gitlab-ci mit den kürzlich eingeführten Rules als sehr nützlich erwiesen. Davor habe ich mir Jenkins von unseren Entwicklern ausgeborgt, aber voll integriert in gitlab find ichs irgendwie schöner.

Der Ablauf:
  - hammer host create erzeugt den Server in VMWare.
  - wait-for-it.sh testet regelmäßig ob ein Login per ssh möglich ist. Da der Key erst mit dem ersten puppetrun ausgebracht wird, wird sichergestellt dass wir "nicht zu früh" vorbeikommen.
  - serverspec überprüft ob die Anforderung erfüllt sind und nicht versehentlich Settings geändert wurden
  - cleanup löscht den Server mittels hammer host delete

jetzt nur noch den Build regelmäßig von gitlab triggern lassen - fertig. 
Ein wenig störend fand ich jeden Tag ein Email von Foreman zu bekommen, dass alle Server erfolgreich gebaut wurden. Hier wäre es schön einen Schalter in hammer zu haben um built notifications für diesen Host abzuschalten.